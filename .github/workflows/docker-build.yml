name: Build and Push Docker Images

on:
  workflow_dispatch:
    inputs:
      endpoint_tag:
        description: 'Endpoint image tag (default: latest)'
        required: false
        default: 'latest'
        type: string
      pipeline_tag:
        description: 'Pipeline image tag (default: latest)'
        required: false
        default: 'latest'
        type: string
      registry_host:
        description: 'Docker registry host (default: localhost:65000)'
        required: false
        default: 'localhost:65000'
        type: string

jobs:
  build-and-push:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build and push Endpoint API image
      run: |
        REGISTRY="${{ github.event.inputs.registry_host || 'localhost:65000' }}"
        TAG="${{ github.event.inputs.endpoint_tag || 'latest' }}"
        
        # Build image
        docker build -t $REGISTRY/mlops-endpoint:${{ github.sha }} -f endpoint/Dockerfile endpoint
        docker tag $REGISTRY/mlops-endpoint:${{ github.sha }} $REGISTRY/mlops-endpoint:$TAG
        
        # Push with HTTP (no TLS verification)
        docker push $REGISTRY/mlops-endpoint:${{ github.sha }}
        docker push $REGISTRY/mlops-endpoint:$TAG
        
    - name: Build and push ML Pipeline image
      run: |
        REGISTRY="${{ github.event.inputs.registry_host || 'localhost:65000' }}"
        TAG="${{ github.event.inputs.pipeline_tag || 'latest' }}"
        
        # Build image
        docker build -t $REGISTRY/mlops-pipeline:${{ github.sha }} -f ml-pipeline/docker/Dockerfile ml-pipeline
        docker tag $REGISTRY/mlops-pipeline:${{ github.sha }} $REGISTRY/mlops-pipeline:$TAG
        
        # Push with HTTP (no TLS verification)
        docker push $REGISTRY/mlops-pipeline:${{ github.sha }}
        docker push $REGISTRY/mlops-pipeline:$TAG
        
    - name: Verify images in registry
      run: |
        echo "Verifying images in registry..."
        curl -s http://${{ github.event.inputs.registry_host || 'localhost:65000' }}/v2/_catalog | jq .
        
    - name: Summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Endpoint Image**: ${{ github.event.inputs.registry_host || 'localhost:65000' }}/mlops-endpoint:${{ github.event.inputs.endpoint_tag || 'latest' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Pipeline Image**: ${{ github.event.inputs.registry_host || 'localhost:65000' }}/mlops-pipeline:${{ github.event.inputs.pipeline_tag || 'latest' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: ${{ github.event.inputs.registry_host || 'localhost:65000' }}" >> $GITHUB_STEP_SUMMARY
